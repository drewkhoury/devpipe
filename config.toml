# devpipe configuration for testing devpipe itself
# Optimized: minimal sequential phases, maximum parallelism

[defaults]
outputRoot = ".devpipe"
fastThreshold = 300
uiMode = "basic"
animationRefreshMs = 500
animatedGroupBy = "phase"

[defaults.git]
mode = "staged_unstaged"

[task_defaults]
enabled = true
workdir = "."
fixType = "helper"

# ============================================================================
# Phase 1: Validation - Static Analysis & Tests
# All checks and tests run in parallel (no dependencies between them)
# ============================================================================
[tasks.phase-validation]
name = "Validation"
desc = "Static analysis, linting, security scans, and all tests"

# Static checks (no execution)
[tasks.go-fmt]
name = "Go Format"
desc = "Verifies that Go code is properly formatted according to gofmt standards without modifying files."
command = "make check-fmt"
type = "check-format"
fixType = "helper"
fixCommand = "make fmt"

[tasks.go-vet]
name = "Go Vet"
desc = "Examines Go code for suspicious constructs and common programming errors that the compiler doesn't catch."
command = "go vet ./..."
type = "check-static"

[tasks.golangci-lint]
name = "Golang CI Lint"
desc = "Runs errcheck, govet, ineffassign, staticcheck, unused, misspell, revive, unconvert, unparam, gocritic, gocyclo, dupl"
command = "make lint"
type = "check-lint"

[tasks.gosec]
name = "Security Scan"
desc = "Scans Go code for security vulnerabilities: SQL injection, hardcoded credentials, weak crypto, command injection, file permissions"
command = "gosec ./..."
type = "check-security"

[tasks.go-mod-tidy]
name = "Go Mod Tidy Check"
command = "echo '→ go mod tidy -diff'"
type = "check-static"

[tasks.validate-configs]
name = "Validate Example Configs"
command = "echo '→ ./devpipe validate config/*.toml'"
type = "check-static"

# Tests (all can run in parallel with checks)
[tasks.unit-tests]
name = "Unit Tests"
command = "echo '→ go test -v ./...'"
type = "test-unit"

[tasks.unit-tests-race]
name = "Unit Tests (Race Detector)"
command = "echo '→ go test -race ./...'"
type = "test-unit"

[tasks.coverage]
name = "Test Coverage"
command = "echo '→ go test -coverprofile=coverage.out -covermode=atomic ./...'"
type = "test-unit"

[tasks.cli-integration]
name = "CLI Integration Tests"
command = "echo '→ Test CLI: help, version, flags, dry-run, validation'"
type = "test-integration"

[tasks.git-integration]
name = "Git Integration Tests"
command = "echo '→ Test git modes: staged, staged_unstaged, ref'"
type = "test-integration"

[tasks.pipeline-integration]
name = "Pipeline Execution Tests"
command = "echo '→ Test: phases, parallel execution, fail-fast, metrics'"
type = "test-integration"

[tasks.benchmarks]
name = "Benchmarks"
command = "echo '→ go test -bench=. -benchmem ./...'"
type = "test-performance"

# ============================================================================
# Phase 2: Build - Compilation & Release Validation
# Only runs after all checks and tests pass (fail-fast)
# ============================================================================
[tasks.phase-build]
name = "Build"
desc = "Compile binary and validate release configuration"

[tasks.build]
name = "Build Binary"
command = "echo '→ go build -o devpipe .'"
type = "build"

[tasks.goreleaser-check]
name = "GoReleaser Validation"
command = "echo '→ goreleaser check'"
type = "build"

# ============================================================================
# Phase 3: End-to-End - Real-world Scenarios
# Uses the built binary from Phase 2 to test complete workflows
# ============================================================================
[tasks.phase-e2e]
name = "End-to-End"
desc = "Test real-world usage scenarios with the built binary"

[tasks.e2e-fresh-install]
name = "Fresh Install"
command = "echo '→ Test: First-time user with no config (auto-generate)'"
type = "test-e2e"

[tasks.e2e-ci-pipeline]
name = "CI Pipeline Simulation"
command = "echo '→ Test: Full CI run with all flags'"
type = "test-e2e"

[tasks.e2e-pre-commit]
name = "Pre-commit Workflow"
command = "echo '→ Test: Fast pre-commit with --fast flag'"
type = "test-e2e"

[tasks.e2e-failure-scenarios]
name = "Failure Handling"
command = "echo '→ Test: fail-fast, continue-on-error, error reporting'"
type = "test-e2e"
