# devpipe configuration for testing devpipe itself
# Optimized: minimal sequential phases, maximum parallelism

[defaults]
outputRoot = ".devpipe"
fastThreshold = 300
uiMode = "basic"
animationRefreshMs = 500
animatedGroupBy = "phase"

[defaults.git]
mode = "staged_unstaged"

[task_defaults]
enabled = true
workdir = "."
fixType = "auto"

# ============================================================================
# Phase 1: Validation - Static Analysis & Tests
# All checks and tests run in parallel (no dependencies between them)
# ============================================================================
[tasks.phase-validation]
name = "Validation"
desc = "Static analysis, linting, security scans, and all tests"

# Static checks (no execution)
[tasks.go-fmt]
name = "Go Format"
desc = "Verifies that Go code is properly formatted according to gofmt standards without modifying files."
command = "make check-fmt"
type = "check-format"
fixCommand = "make fmt"

[tasks.go-vet]
name = "Go Vet"
desc = "Examines Go code for suspicious constructs and common programming errors that the compiler doesn't catch."
command = "go vet ./..."
type = "check-static"

[tasks.golangci-lint]
name = "Golang CI Lint"
desc = "Runs errcheck, govet, ineffassign, staticcheck, unused, misspell, revive, unconvert, unparam, gocritic, gocyclo, dupl"
command = "make lint"
type = "check-lint"
fixType = "helper"
fixCommand = "golangci-lint run --fix"

[tasks.gosec]
name = "Security Scan (gosec)"
desc = "Scans Go code for security vulnerabilities: SQL injection, hardcoded credentials, weak crypto, command injection, file permissions"
command = "make gosec"
type = "check-security"

[tasks.codeql]
name = "Security Scan (CodeQL)"
desc = "Deep security analysis with CodeQL: detects complex vulnerabilities, data flow issues, and security patterns"
command = "make codeql-analyze"
type = "check-security"
outputType = "sarif"
outputPath = "tmp/codeql/results.sarif"

[tasks.go-mod-tidy]
name = "Go Mod Tidy Check"
desc = "Verifies go.mod and go.sum are tidy and up-to-date with no missing or unused dependencies"
command = "go mod tidy -diff"
type = "check-static"

# Tests (all can run in parallel with checks)
[tasks.unit-tests]
name = "Unit Tests"
desc = "Run all unit tests and generate JUnit XML report"
command = "make test-junit"
type = "test-unit"
outputType = "junit"
outputPath = "artifacts/junit.xml"

[tasks.bdd-tests]
name = "BDD Tests"
desc = "Run behavior-driven development tests using godog"
command = "make test-bdd"
type = "test-integration"

# ============================================================================
# Phase 2: Build - Compilation & Release Validation
# Only runs after all checks and tests pass (fail-fast)
# ============================================================================
[tasks.phase-build]
name = "Build"
desc = "Compile binary and validate release configuration"

[tasks.build]
name = "Build Binary"
command = "make build"
type = "build"

# ============================================================================
# Phase 3: Funcational Testing
# Test against the build binary
# ============================================================================
[tasks.phase-functional]
name = "Functional Testing"
desc = "Test against the build binary"

[tasks.test-version]
name = "Test Version"
command = "./devpipe version"
type = "test"

[tasks.test-artifacts]
name = "Test Artifact"
desc = "Runs devpipe against a directory with various valid and invalid files"
command = "make test-artifacts"
type = "test"

[tasks.test-failures]
name = "Test Failures"
desc = "Run all failure tests (check test-fail-fast and test-continue-on-fail do what they are meant to)"
command = "make test-failures"
type = "test"

[tasks.validate]
name = "Validate"
desc = "Validate default config.toml"
command = "./devpipe validate"
type = "validate"

[tasks.validate-configs]
name = "Validate Example Configs"
desc = "Validates config.toml and all example TOML config files for correct syntax and valid configuration options"
command = "./devpipe validate config.toml config/*.toml"
type = "validate"